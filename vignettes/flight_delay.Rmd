---
title: "Flight delay prediction using ridgereg"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Flight delay prediction using ridgereg}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
library(liu.ridgereg)
library(caret)
library(dplyr)
library(nycflights13)
```

# Example: Predicting flight departure delays

In this vignette, we demonstrate how to use the `ridgereg()` function from the `liu.ridgereg` package to model flight departure delays using data from **nycflights13**. We also evaluate predictive performance using RMSE.

```{r data-prep}
# Prepare data
df <- nycflights13::flights |>
  dplyr::select(dep_delay, arr_delay, air_time, distance) |>
  dplyr::filter(!is.na(dep_delay), !is.na(arr_delay), !is.na(air_time), !is.na(distance))
```

```{r split-train-test}
# Split into training and testing sets
set.seed(123)
train_index <- caret::createDataPartition(df$dep_delay, p = 0.8, list = FALSE)
train <- df[train_index, ]
test <- df[-train_index, ]
```

```{r model-fit}
# Fit ridge regression model with lambda = 1
model <- ridgereg(dep_delay ~ arr_delay + air_time + distance, data = train, lambda = 1)
summary(model)
```

```{r prediction}
# Predict on test data
pred <- predict(model, newdata = test)

# Evaluate performance
rmse <- sqrt(mean((pred - test$dep_delay)^2))
rmse
```

The lower the RMSE, the better the predictive performance.



# Visualizing Flight Delays (Enhanced)

This section adds three detailed visualizations about flight delays using **nycflights13** data.

## 1️⃣ Flight Delay Map

```{r delay-map, fig.width=6, fig.height=4}
library(ggplot2); library(dplyr); library(nycflights13)
flights <- nycflights13::flights
airports <- nycflights13::airports

delay_summary <- flights %>%
  mutate(delay = coalesce(arr_delay, dep_delay)) %>%
  filter(!is.na(delay)) %>%
  group_by(origin) %>%
  summarise(mean_delay = mean(delay), n = n(), .groups = "drop")

airport_info <- airports %>% select(faa, name, lat, lon)

df <- delay_summary %>%
  left_join(airport_info, by = c("origin" = "faa")) %>%
  filter(!is.na(lat), !is.na(lon))

ggplot(df, aes(lon, lat, size = n, color = mean_delay)) +
  geom_point(alpha = 0.8) +
  scale_color_viridis_c(option = "plasma") +
  scale_size_continuous(name = "Number of Flights") +
  labs(title = "Average Flight Delay by Airport",
       subtitle = "Data source: nycflights13",
       x = "Longitude", y = "Latitude",
       color = "Mean Delay (min)") +
  theme_minimal()
```
*Interpretation:* Airports with more flights (larger points) often show higher mean delays (warmer colors).

## 2️⃣ Delay Distribution

```{r delay-dist, fig.width=6, fig.height=4}
ggplot(flights, aes(x = coalesce(arr_delay, dep_delay))) +
  geom_histogram(bins = 60, fill = "steelblue", color = "white") +
  xlim(-50, 200) +
  labs(title = "Distribution of Flight Delays",
       x = "Delay (minutes)", y = "Number of Flights") +
  theme_minimal()
```
*Interpretation:* The majority of flights have small delays, but there are some extreme delay cases forming a long tail.

## 3️⃣ Mean Delay by Airline

```{r carrier-delay, fig.width=6, fig.height=4}
carrier_delay <- flights %>%
  mutate(delay = coalesce(arr_delay, dep_delay)) %>%
  group_by(carrier) %>%
  summarise(mean_delay = mean(delay, na.rm = TRUE)) %>%
  arrange(desc(mean_delay))

ggplot(carrier_delay, aes(x = reorder(carrier, mean_delay), y = mean_delay)) +
  geom_col(fill = "darkorange") +
  coord_flip() +
  labs(title = "Average Delay by Airline Carrier",
       x = "Carrier", y = "Mean Delay (min)") +
  theme_minimal()
```
*Interpretation:* Some carriers consistently exhibit higher average delays, which could indicate differences in operational efficiency.

